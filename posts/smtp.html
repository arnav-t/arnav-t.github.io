<!doctype html>
<html lang="en-us">
  <head>
    <title>Discovering Open SMTP Relays // Arnav Tiwari</title>
    <link rel="shortcut icon" href="../favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.79.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="arnav-t" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://arnav-t.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Discovering Open SMTP Relays"/>
<meta name="twitter:description" content="A simple way to discover Open SMTP Relays in the wild Disclaimer: This article is for educational purposes only.
What is SMTP? SMTP is an ancient protocol used for email transmission. As with most ancient protocols, it is relatively simple in design. SMTP works on plaintext only which makes it very easy to play around with.
What are SMTP Relays? SMTP Relays are like your local post office. They take your mail, figure out where to send it (in this case using DNS), and send it either to another post office along the way or directly to your intended recipient if possible."/>

    <meta property="og:title" content="Discovering Open SMTP Relays" />
<meta property="og:description" content="A simple way to discover Open SMTP Relays in the wild Disclaimer: This article is for educational purposes only.
What is SMTP? SMTP is an ancient protocol used for email transmission. As with most ancient protocols, it is relatively simple in design. SMTP works on plaintext only which makes it very easy to play around with.
What are SMTP Relays? SMTP Relays are like your local post office. They take your mail, figure out where to send it (in this case using DNS), and send it either to another post office along the way or directly to your intended recipient if possible." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arnav-t.github.io/posts/smtp.html" />
<meta property="article:published_time" content="2019-11-14T01:06:18+05:30" />
<meta property="article:modified_time" content="2019-11-14T01:06:18+05:30" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://arnav-t.github.io/"><img class="app-header-avatar" src="../images/arnav-t.jpg" alt="arnav-t" /></a>
      <h1>Arnav Tiwari</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="../about/">About</a>
             - 
          
          <a class="app-header-menu-item" href="../">Posts</a>
             - 
          
          <a class="app-header-menu-item" href="../tags/">Tags</a>
      </nav>
      <p>An unassorted collection of my ramblings on software and cybersecurity.</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/arnav-t" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://www.linkedin.com/in/arnav-t" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://stackoverflow.com/users/3127633/avz" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg></a>
        
          <a target="_blank" href="https://www.youtube.com/channel/UCg2dm7SxYUOg4VLujWFxo8A" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-youtube">
  <title>youtube</title>
  <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg></a>
        
          <a target="_blank" href="mailto:avznav@gmail.com" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail">
  <title>mail</title>
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Discovering Open SMTP Relays</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Nov 14, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
              <a class="tag" href="https://arnav-t.github.io/tags/security.html">Security</a>
              <a class="tag" href="https://arnav-t.github.io/tags/python.html">Python</a>
              <a class="tag" href="https://arnav-t.github.io/tags/shell.html">Shell</a>
              <a class="tag" href="https://arnav-t.github.io/tags/2019.html">2019</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="a-simple-way-to-discover-open-smtp-relays-in-the-wild">A simple way to discover Open SMTP Relays in the wild</h2>
<p><em><strong>Disclaimer</strong>: This article is for educational purposes only.</em></p>
<h3 id="what-is-smtp">What is SMTP?</h3>
<p>SMTP is an ancient protocol used for email transmission. As with most ancient protocols, it is relatively simple in design. SMTP works on plaintext only which makes it very easy to play around with.</p>
<h3 id="what-are-smtp-relays">What are SMTP Relays?</h3>
<p>SMTP Relays are like your local post office. They take your mail, figure out where to send it (in this case using DNS), and send it either to another post office along the way or directly to your intended recipient if possible. Much like a post office, each SMTP Relay has a &ldquo;domain&rdquo;. The SMTP server only allows emails originating from or destined to the addresses belonging to this domain. For example, <code>mx.example.com</code> will be responsible for handling all the emails to and from <code>*@example.com</code>.</p>
<h3 id="what-are-open-smtp-relays">What are Open SMTP Relays?</h3>
<p>Usually, SMTP servers are configured to allow emails to or from their own domain. Open SMTP servers, however, allow <em>anyone</em> to send emails to anyone else on the internet! They were once commonplace but disappeared because of abuse by spammers.</p>
<h3 id="whats-the-big-deal">What&rsquo;s the big deal?</h3>
<p>An open SMTP server allows you to forge sender information and impersonate anyone on the internet! This made them a really powerful tool for spamming and phishing.</p>
<h3 id="how-to-find-them">How to find them?</h3>
<p>First, we need to find a mail server to test. How do we do that? Well, we can just look up DNS records! Let&rsquo;s say if you wanted to find out the mail servers of <code>google.com</code>, you could use the <code>dig</code> utility:</p>
<pre><code>$ dig google.com MX
</code></pre><pre><code>; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.13-Ubuntu &lt;&lt;&gt;&gt; google.com MX
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27593
;; flags: qr rd ad; QUERY: 1, ANSWER: 14, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available

;; QUESTION SECTION:
;google.com.                    IN      MX

;; ANSWER SECTION:
google.com.             0       IN      MX      40 alt3.aspmx.l.google.com.
google.com.             0       IN      MX      30 alt2.aspmx.l.google.com.
google.com.             0       IN      MX      10 aspmx.l.google.com.
google.com.             0       IN      MX      50 alt4.aspmx.l.google.com.
google.com.             0       IN      MX      20 alt1.aspmx.l.google.com.
aspmx.l.google.com.     0       IN      A       74.125.24.26
alt1.aspmx.l.google.com. 0      IN      A       74.125.28.26
alt2.aspmx.l.google.com. 0      IN      A       74.125.137.26
alt3.aspmx.l.google.com. 0      IN      A       173.194.199.26
alt4.aspmx.l.google.com. 0      IN      A       209.85.146.26
ns1.google.com.         0       IN      A       216.239.32.10
ns2.google.com.         0       IN      A       216.239.34.10
ns3.google.com.         0       IN      A       216.239.36.10
ns4.google.com.         0       IN      A       216.239.38.10

;; Query time: 102 msec
;; SERVER: 172.30.208.1#53(172.30.208.1)
;; WHEN: Wed Nov 11 04:29:58 IST 2019
;; MSG SIZE  rcvd: 538

</code></pre><p>To test any of them, we can open a TCP socket on port 25 (using the <code>netcat</code> utility, for example) and try to send SMTP commands as if we&rsquo;re talking to an open SMTP relay.</p>
<pre><code>HELO example.com
MAIL FROM:test@example.com
RCPT TO:test@test.com
QUIT
</code></pre><p>This would fail in a well-configured relay, but an open SMTP relay would allow your request to go through. We can even automate this using a shell script to test a bunch of SMTP servers simultaneously.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">while</span> read host
<span style="color:#66d9ef">do</span>
    output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#39;HELO example.com\nMAIL FROM:test@example.com\nRCPT TO:test@test.com\nQUIT\n&#39;</span> | nc $host <span style="color:#ae81ff">25</span> -w <span style="color:#ae81ff">1</span> 2&gt; /dev/null<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">if</span> ! <span style="color:#f92672">[[</span> -z $output <span style="color:#f92672">]]</span>
    <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">if</span> ! <span style="color:#f92672">[[</span> $output <span style="color:#f92672">=</span>~ denied <span style="color:#f92672">]]</span>
        <span style="color:#66d9ef">then</span>
            echo $host
        <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span> &lt; <span style="color:#e6db74">${</span>1<span style="color:#66d9ef">:-</span>/dev/stdin<span style="color:#e6db74">}</span>
</code></pre></div><p>To make things go faster, we can even multiprocess it in Python using the <code>smtplib</code> module!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> multiprocessing <span style="color:#f92672">as</span> mp
<span style="color:#f92672">import</span> smtplib

counter <span style="color:#f92672">=</span> mp<span style="color:#f92672">.</span>Value(<span style="color:#e6db74">&#39;i&#39;</span>, <span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">testServer</span>(host, port<span style="color:#f92672">=</span><span style="color:#ae81ff">465</span>):
	<span style="color:#66d9ef">global</span> counter
	<span style="color:#66d9ef">with</span> counter<span style="color:#f92672">.</span>get_lock():
		counter<span style="color:#f92672">.</span>value <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">if</span> counter<span style="color:#f92672">.</span>value<span style="color:#f92672">%</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
		<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;{counter.value}&#39;</span>)
	<span style="color:#66d9ef">try</span>:
		s <span style="color:#f92672">=</span> smtplib<span style="color:#f92672">.</span>SMTP(host<span style="color:#f92672">=</span>host, port<span style="color:#f92672">=</span>port, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
		s<span style="color:#f92672">.</span>sendmail(<span style="color:#e6db74">&#39;hi@test.com&#39;</span>, [f<span style="color:#e6db74">&#34;admin@{&#39;.&#39;.join(host.split(&#39;.&#39;)[1:])}&#34;</span>], <span style="color:#e6db74">&#39;message goes here&#39;</span>)
		<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{host}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
		<span style="color:#66d9ef">return</span> host
	<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
		<span style="color:#66d9ef">print</span>(e)
		<span style="color:#66d9ef">return</span> False

<span style="color:#66d9ef">if</span> __name__<span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;results.txt&#39;</span>) <span style="color:#66d9ef">as</span> f:
		hosts <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
	<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;+&#39;</span>)
	hosts <span style="color:#f92672">=</span> [host<span style="color:#f92672">.</span>rstrip() <span style="color:#66d9ef">for</span> host <span style="color:#f92672">in</span> hosts]
	p <span style="color:#f92672">=</span> mp<span style="color:#f92672">.</span>Pool(<span style="color:#ae81ff">16</span>)
	res <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>map(testServer, hosts)
	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;results.txt&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
		<span style="color:#66d9ef">for</span> host <span style="color:#f92672">in</span> res:
			<span style="color:#66d9ef">if</span> host:
				f<span style="color:#f92672">.</span>write(f<span style="color:#e6db74">&#39;{host}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
